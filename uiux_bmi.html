<!DOCTYPE html>
<html>

<style type="text/css">
    .center {
        max-width: 600px;
        margin: auto;
        width: 60%;
        padding: 10px;
    }

    fieldset {
        background-color: rgba(150, 77, 18, 0.474);
    }

    legend {
        background-color: rgb(150, 77, 18);
        color: white;
        padding: 5px 10px;
        font-size: medium;
    }

    input {
        margin: 5px;
    }

    h3 {
        position: relative;
        left: 150px;
    }
</style>

<body class="center">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        var persons = new Map();        // save all persons' data
        var over_persons = new Map();   // over-weight persons
        var under_persons = new Map();  // under-weight persons
        var normal_persons = new Map(); // not over and not under
        var pie_data;

        function drawPie() {

            // set the data 
            pie_data = [{ level: "Normal", count: normal_persons.size },
            { level: "Under-w", count: under_persons.size },
            { level: "Over-w", count: over_persons.size }];
            var data = pie_data;

            var color = [d3.rgb(0, 160, 0),d3.rgb(252, 157, 14),d3.rgb(214, 39, 40)];

            // set the svg contain
            var svg = d3.select("svg"),
                width = svg.attr("width"),
                height = svg.attr("height"),
                radius = 150;

            var g = svg.append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            // data range color
            var ordScale = d3.scaleOrdinal()
                .domain(data)
                .range(color);

            // make a pie
            var pie = d3.pie().value(function (d) { return d.count; });
            // set arcpath
            var arcpath = d3.arc()
                .outerRadius(radius)
                .innerRadius(0);

            // setting arc
            var arc = g.selectAll("arc")
                .data(pie(data))
                .enter();

            arc.append("path")
                .attr("d", arcpath)
                .attr("stroke", "white")
                .attr("stroke-width", "2px")
                .attr("fill", function (d) { return ordScale(d.data.level); });
                
            arc.append("text")
                .attr("transform", function (d) { return "translate(" + arcpath.centroid(d) + ")";})
                .attr("text-anchor", "middle")
                .text(function (d) { return d.data.level; })
                .style("font-family", "fantasy")
                .style("font-size", 18);
        }

        
        function addToPersonMap(person, h, w, bmi) {
            persons.set(person, [h, w, bmi]);
            if (bmi < 18.5) {
                under_persons.set(person, [h, w, bmi]);
            }
            else if (bmi > 25) {
                over_persons.set(person, [h, w, bmi]);
            }
            else normal_persons.set(person, [h, w, bmi]);
        }
        
        
        function addPerson() {
            
            let pname = document.forms["bmi"]["pname"].value;
            let h1 = parseInt(document.forms["bmi"]["h1"].value);
            let h2 = parseInt(document.forms["bmi"]["h2"].value);
            let w = document.forms["bmi"]["weight"].value;

            if (pname == "" || h1 == "" || h2 == "" || w == "") {
                alert("Please fill all the blanks");
                return false;
            }

            let h = (h1 * 10 + h2) / 100;
            bmi = w / (h * h);
            bmi = bmi.toFixed(2);
            
            newPersonStr = `<strong>${pname}</strong>: ${h}cm, ${w}kg, BMI is <strong>${bmi}</strong>`

            let newPerson = document.getElementById("p-new-person")
            newPerson.innerHTML = newPersonStr + " is added!"

            document.forms["bmi"]["pname"].value = ""; //initialize
            
            // add the person to the Map
            addToPersonMap(pname, h, w, bmi);
        }

        function randomInput() {
            const minH = 150; const maxH = 180;
            const minW = 50; const maxW = 70;
            for (let i = 0; i < 50; i++) {
                let pname = 'P' + i.toString();
                let h = ((Math.random() * (maxH - minH) + minH) / 100).toFixed(1);
                let w = (Math.random() * (maxW - minW) + minW).toFixed(1);
                let bmi = (w / (h * h)).toFixed(2);
                addToPersonMap(pname, h, w, bmi);
            }
            showStat();
        }

    
        function personString(personMap) {
            text = ""
            for (let [u, d] of personMap) {
                text += `<li><strong>${u}</strong>: ${d[0]}cm, ${d[1]}kg, BMI: ${d[2]}</li>`;
            }
            return text;
        }

        /**
         * Hide the statistics of the persons' BMI
         * It will also (1) show the input form
         *              (2) switch the button of input/statistics
        */

        function hideStat() {
            let div_stat = document.getElementById("div-stat");
            let form_BMI = document.getElementById("form-BMI");
            let btn_show_stat = document.getElementById("btn-show-stat");

            hideElement(div_stat);
            showElement(form_BMI);
            btn_show_stat.value = "Show Statistics";
            btn_show_stat.onclick = function () { showStat(); };
        }

        /**
         * Show the statistics of the persons' BMI
         * It will also (1) hide the input form
         *              (2) switch the button of input/statistics
        */

        function showStat() {
            if(persons.size == 0){
                alert("Data is empty!");
                return;
            }
            let div_stat = document.getElementById("div-stat");
            let form_BMI = document.getElementById("form-BMI");
            let btn_show_stat = document.getElementById("btn-show-stat");
            showElement(div_stat);
            hideElement(form_BMI);
            btn_show_stat.value = "Input data";
            btn_show_stat.onclick = function () { hideStat(); };

            let summary = document.getElementById("p-summary");
            summary.innerHTML = `Over-weight : ${over_persons.size}<br>
            Under-weight : ${under_persons.size}<br>
            Normal : ${normal_persons.size}`;

            drawPie();

            document.getElementById("ul-over-w").innerHTML = `${personString(over_persons)}`;

            document.getElementById("ul-under-w").innerHTML = `${personString(under_persons)}`;

            document.getElementById("ul-normal-w").innerHTML = `${personString(normal_persons)}`;
        }

        /**
         * Show an HTML element
         */

        function showElement(element) {
            element.removeAttribute("hidden");
        }

        /**
         * Hide an HTML element
         */

        function hideElement(element) {
            element.setAttribute("hidden", true);
        }

    </script>

    <h1 style="text-align: center;">BMI System</h1>

    <button onClick="window.location.reload();">Reload</button>
    <span style="display:flex; float:right">
        <input type="Button" id="btn-show-stat" value="Show Statistics" onclick="showStat()">
    </span>
    <br>

    <form name="bmi" id="form-BMI">
        <p>Please input and submit the Name, Weight and Height</p>

        <fieldset>
            <legend>Input data for BMI calculation</legend>
            <label for="pname"> Name:
                <input type="text" id="pname" name="pname" value="" required>
            </label>
            <br>
            <label for="weight"> Weight (kg):
                <input type="number" id="weight" name="weight" value="60" min="30" max="200">
            </label>
            <br>
            <label for="height"> Height (cm):
                <select id="h1">
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                </select>
                <select id="h2">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </label>
            <input type="Button" value="Submit" onclick="addPerson()" style="float: right;">
        </fieldset>

        <input type="Button" value="Random Input" onclick="randomInput()">
        <p id="p-new-person"></p>
    </form>


    <div id="div-stat" hidden>
        <fieldset>
            <legend>Statistics: </legend>
            <svg width="596" height="300"></svg>
            
            <h2 style="font-family: Arial, Helvetica, sans-serif;">Total Number</h2>
            <p id="p-summary"></p>
        </fieldset>

        <hr>

        <h3 style="color:rgb(255, 0, 0)">‚õπÔ∏è  Over weight , please exercise  ‚õπÔ∏è</h3>
        <ul id="ul-over-w" style="background-color: rgb(255, 144, 144);"></ul>

        <hr>

        <h3 style="color:rgb(252, 157, 14)">üçñUnder weight,please eat moreüçñ</h3>
        <ul id="ul-under-w" style="background-color: rgb(255, 214, 139);"></ul>
        
        <hr>

        <h3 style="color:rgb(0, 180, 0)">üëç  Normal weight , keep going  üëç</h3>
        <ul id="ul-normal-w" style="background-color: rgb(165, 252, 165);"></ul>
    </div>

</body>

</html>